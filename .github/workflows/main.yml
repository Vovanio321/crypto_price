name: Send Message with Custom Emojis

on:
  workflow_dispatch:

jobs:
  edit-message:
    runs-on: ubuntu-latest
    steps:
      - name: Edit existing message with custom emojis
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
          # optionally set TELEGRAM_MESSAGE_ID in repo/workflow secrets or manually in "Run workflow"
          TELEGRAM_MESSAGE_ID: ${{ secrets.TELEGRAM_MESSAGE_ID }}
        run: |
          python3 - <<'PY'
          import os, requests, json, sys

          BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
          CHANNEL = os.environ.get("TELEGRAM_CHANNEL")  # must be numeric -100...
          MSG_ID_ENV = os.environ.get("TELEGRAM_MESSAGE_ID")

          if not BOT_TOKEN or not CHANNEL:
              print("Set TELEGRAM_BOT_TOKEN and TELEGRAM_CHANNEL secrets (CHANNEL must be -100...)")
              sys.exit(1)

          # default message id from your link -> message 8
          try:
              MESSAGE_ID = int(MSG_ID_ENV) if MSG_ID_ENV else 8
          except Exception:
              print("Invalid TELEGRAM_MESSAGE_ID:", MSG_ID_ENV)
              sys.exit(1)

          COINS = {
              "BTC": "90",
              "ETH": "80",
              "BNB": "2710"
          }

          # –¢–í–û–ò custom_emoji_id
          EMOJI_IDS = {
              "BTC": "5213021529092170717",
              "ETH": "5215633431848848497",
              "BNB": "5212948037906766349"
          }

          API = f"https://api.telegram.org/bot{BOT_TOKEN}"

          def utf16_len(s: str) -> int:
              # Telegram —Å—á–∏—Ç–∞–µ—Ç offsets/length –≤ UTF-16 code units
              return len(s.encode("utf-16-le")) // 2

          def get_prices():
              url = f"https://api.coinlore.net/api/ticker/?id={','.join(COINS.values())}"
              r = requests.get(url, timeout=15)
              r.raise_for_status()
              data = r.json()
              return {item["symbol"]: float(item["price_usd"]) for item in data}

          try:
              prices = get_prices()
          except Exception as e:
              print("Failed to fetch prices:", e)
              sys.exit(1)

          # ‚ö†Ô∏è –í–ê–ñ–ù–û: fallback must match the custom emoji 'alt' exactly.
          # –¢—ã —Å–∫–∞–∑–∞–ª, —á—Ç–æ –æ–Ω —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ:
          FALLBACK = "üìä"

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç (—Ä–æ–≤–Ω–æ —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –≤–∏–¥–µ—Ç—å –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏)
          text = (
              f"{FALLBACK} {prices['BTC']:.2f}$ "
              f"{FALLBACK} {prices['ETH']:.2f}$ "
              f"{FALLBACK} {prices['BNB']:.2f}$"
          )

          # –ù–∞—Ö–æ–¥–∏–º UTF-16 offsets –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—Ö–æ–∂–¥–µ–Ω–∏—è FALLBACK
          offsets = []
          for i, ch in enumerate(text):
              if ch == FALLBACK:
                  offsets.append(utf16_len(text[:i]))

          coins = ["BTC", "ETH", "BNB"]
          if len(offsets) < len(coins):
              print("Not enough fallback emoji occurrences found in text.")
              print("text:", text)
              sys.exit(1)

          entities = []
          for i, coin in enumerate(coins):
              entities.append({
                  "type": "custom_emoji",
                  "offset": offsets[i],
                  "length": utf16_len(FALLBACK),
                  "custom_emoji_id": EMOJI_IDS[coin]
              })

          payload = {
              "chat_id": CHANNEL,
              "message_id": MESSAGE_ID,
              "text": text,
              "entities": entities
          }

          # Use editMessageText to edit the existing message
          r = requests.post(f"{API}/editMessageText", json=payload, timeout=15)
          try:
              j = r.json()
          except Exception:
              print("Non-JSON response:", r.text)
              sys.exit(1)

          print("editMessageText response:", json.dumps(j, ensure_ascii=False))

          if not j.get("ok"):
              print("editMessageText failed. Description:", j.get("description"))
              # Helpful debugging hints
              print("""
Possible reasons:
- Bot is not the author of the message (bots can normally only edit messages they sent).
- Bot doesn't have rights to edit messages in the channel.
- custom_emoji_id is not available to this bot (forbidden).
- Offsets/length don't match the text (we used UTF-16 counting here).
Check the JSON response above for the 'description' field from Telegram.
""")
              sys.exit(1)

          print("Message edited successfully, message_id =", MESSAGE_ID)
          PY
