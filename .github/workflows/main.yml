name: Send Message with Custom Emojis

on:
  workflow_dispatch:

jobs:
  send-message:
    runs-on: ubuntu-latest
    steps:
      - name: Send message with custom emojis
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        run: |
          python3 - <<'PY'
          import os, requests, json, sys

          BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
          CHANNEL = os.environ.get("TELEGRAM_CHANNEL")  # must be -100...
          if not BOT_TOKEN or not CHANNEL:
              print("Set TELEGRAM_BOT_TOKEN and TELEGRAM_CHANNEL secrets")
              sys.exit(1)

          COINS = {
              "BTC": "90",
              "ETH": "80",
              "BNB": "2710"
          }

          # –¢–í–û–ò custom_emoji_id
          EMOJI_IDS = {
              "BTC": "5213021529092170717",
              "ETH": "5215633431848848497",
              "BNB": "5212948037906766349"
          }

          API = f"https://api.telegram.org/bot{BOT_TOKEN}"

          def utf16_len(s: str) -> int:
              # Telegram —Å—á–∏—Ç–∞–µ—Ç offsets –≤ UTF-16 code units
              return len(s.encode("utf-16-le")) // 2

          def get_prices():
              url = f"https://api.coinlore.net/api/ticker/?id={','.join(COINS.values())}"
              r = requests.get(url, timeout=15)
              r.raise_for_status()
              data = r.json()
              return {item["symbol"]: float(item["price_usd"]) for item in data}

          try:
              prices = get_prices()
          except Exception as e:
              print("Failed to fetch prices:", e)
              sys.exit(1)

          # ‚ö†Ô∏è fallback emoji ‚Äî –æ–Ω –î–û–õ–ñ–ï–ù —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å alt —É custom emoji
          FALLBACK = "üìä"

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
          text = (
              f"{FALLBACK} {prices['BTC']:.2f}$ "
              f"{FALLBACK} {prices['ETH']:.2f}$ "
              f"{FALLBACK} {prices['BNB']:.2f}$"
          )

          # –ù–∞—Ö–æ–¥–∏–º UTF-16 offsets –¥–ª—è –∫–∞–∂–¥–æ–≥–æ üìä
          offsets = []
          for i, ch in enumerate(text):
              if ch == FALLBACK:
                  offsets.append(utf16_len(text[:i]))

          entities = []
          coins = ["BTC", "ETH", "BNB"]

          for i, coin in enumerate(coins):
              entities.append({
                  "type": "custom_emoji",
                  "offset": offsets[i],
                  "length": utf16_len(FALLBACK),
                  "custom_emoji_id": EMOJI_IDS[coin]
              })

          payload = {
              "chat_id": CHANNEL,
              "text": text,
              "entities": entities
          }

          r = requests.post(f"{API}/sendMessage", json=payload, timeout=15)
          try:
              j = r.json()
          except Exception:
              print("Non-JSON response:", r.text)
              sys.exit(1)

          print("sendMessage response:", json.dumps(j, ensure_ascii=False))

          if not j.get("ok"):
              print("sendMessage failed:", j.get("description"))
              sys.exit(1)

          print("Message sent successfully, message_id =", j["result"]["message_id"])
          PY
