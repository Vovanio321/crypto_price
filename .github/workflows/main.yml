name: Send Message with Custom Emojis

on:
  workflow_dispatch:

jobs:
  edit-message:
    runs-on: ubuntu-latest
    steps:
      - name: Edit existing message with custom emojis
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
          TELEGRAM_MESSAGE_ID: ${{ secrets.TELEGRAM_MESSAGE_ID }}
        run: |
          python3 - <<'PY'
          import os, requests, json, sys

          BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
          CHANNEL = os.environ.get("TELEGRAM_CHANNEL")
          MSG_ID_ENV = os.environ.get("TELEGRAM_MESSAGE_ID")

          if not BOT_TOKEN or not CHANNEL:
              print("Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHANNEL")
              sys.exit(1)

          MESSAGE_ID = int(MSG_ID_ENV) if MSG_ID_ENV else 8

          COINS = {
              "BTC": "90",
              "ETH": "80",
              "BNB": "2710"
          }

          EMOJI_IDS = {
              "BTC": "5213021529092170717",
              "ETH": "5215633431848848497",
              "BNB": "5212948037906766349"
          }

          API = f"https://api.telegram.org/bot{BOT_TOKEN}"

          def utf16_len(s: str) -> int:
              return len(s.encode("utf-16-le")) // 2

          def get_prices():
              url = f"https://api.coinlore.net/api/ticker/?id={','.join(COINS.values())}"
              r = requests.get(url, timeout=15)
              r.raise_for_status()
              data = r.json()
              return {item["symbol"]: float(item["price_usd"]) for item in data}

          try:
              prices = get_prices()
          except Exception as e:
              print("Failed to fetch prices:", e)
              sys.exit(1)

          FALLBACK = "ðŸ“Š"

          text = (
              f"{FALLBACK} {prices['BTC']:.2f}$ "
              f"{FALLBACK} {prices['ETH']:.2f}$ "
              f"{FALLBACK} {prices['BNB']:.2f}$"
          )

          offsets = []
          for i, ch in enumerate(text):
              if ch == FALLBACK:
                  offsets.append(utf16_len(text[:i]))

          coins = ["BTC", "ETH", "BNB"]

          if len(offsets) < 3:
              print("Fallback emoji count mismatch")
              sys.exit(1)

          entities = []
          for i, coin in enumerate(coins):
              entities.append({
                  "type": "custom_emoji",
                  "offset": offsets[i],
                  "length": utf16_len(FALLBACK),
                  "custom_emoji_id": EMOJI_IDS[coin]
              })

          payload = {
              "chat_id": CHANNEL,
              "message_id": MESSAGE_ID,
              "text": text,
              "entities": entities
          }

          r = requests.post(f"{API}/editMessageText", json=payload, timeout=15)

          try:
              j = r.json()
          except Exception:
              print("Non-JSON response:", r.text)
              sys.exit(1)

          print("editMessageText response:", json.dumps(j, ensure_ascii=False))

          if not j.get("ok"):
              print("editMessageText failed:", j.get("description"))
              print("Bot must be the author of the message and have rights to edit it")
              sys.exit(1)

          print("Message edited successfully:", MESSAGE_ID)
          PY
