name: Edit Telegram Message with Custom Emojis

on:
  workflow_dispatch:        # –∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é
  schedule:
    - cron: "*/5 * * * *"  # –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

jobs:
  edit-message:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: python3 -m pip install --upgrade pip telethon requests

      - name: Edit Telegram Message (Low-Level)
        env:
          TELETHON_API_ID: ${{ secrets.TELETHON_API_ID }}
          TELETHON_API_HASH: ${{ secrets.TELETHON_API_HASH }}
          TELETHON_SESSION: ${{ secrets.TELETHON_SESSION }}
        run: |
          python3 - <<'PY'
          import os, asyncio, requests
          from telethon import TelegramClient, types
          from telethon.sessions import StringSession
          from telethon.tl.functions.messages import EditMessageRequest

          # --- Config ---
          CHANNEL = '@test_canal414'  # –≤–∞—à –∫–∞–Ω–∞–ª
          MESSAGE_ID = 8

          COINS = {"BTC": "90", "ETH": "80", "BNB": "2710"}
          EMOJI_IDS = {
              "BTC": 5213021529092170717,
              "ETH": 5215633431848848497,
              "BNB": 5212948037906766349
          }
          # ----------------

          API_ID = int(os.environ['TELETHON_API_ID'])
          API_HASH = os.environ['TELETHON_API_HASH']
          SESSION = os.environ['TELETHON_SESSION']

          def utf16_len(s: str) -> int:
              return len(s.encode("utf-16-le")) // 2

          def get_prices():
              url = f"https://api.coinlore.net/api/ticker/?id={','.join(COINS.values())}"
              r = requests.get(url, timeout=10)
              r.raise_for_status()
              data = r.json()
              return {item["symbol"]: float(item["price_usd"]) for item in data}

          async def main():
              client = TelegramClient(StringSession(SESSION), API_ID, API_HASH)
              await client.start()

              prices = get_prices()
              text = f"üìä {prices['BTC']:.2f}$ üìä {prices['ETH']:.2f}$ üìä {prices['BNB']:.2f}$"

              fallback = "üìä"
              offsets = []
              running = ""
              for ch in text:
                  if ch == fallback:
                      offsets.append(utf16_len(running))
                  running += ch

              coins = ["BTC", "ETH", "BNB"]
              length = utf16_len(fallback)

              entities = [
                  types.MessageEntityCustomEmoji(offset=offsets[i], length=length, document_id=EMOJI_IDS[coins[i]])
                  for i in range(len(coins))
              ]

              try:
                  await client(EditMessageRequest(
                      peer=CHANNEL,
                      id=MESSAGE_ID,
                      message=text,
                      entities=entities
                  ))
                  print("–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —ç–º–æ–¥–∑–∏!")
              except Exception as e:
                  print("–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", repr(e))
                  try:
                      await client(EditMessageRequest(
                          peer=CHANNEL,
                          id=MESSAGE_ID,
                          message=text
                      ))
                      print("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –±–µ–∑ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —ç–º–æ–¥–∑–∏ (fallback).")
                  except Exception as e2:
                      print("Fallback edit —Ç–∞–∫–∂–µ –Ω–µ —É–¥–∞–ª—Å—è:", repr(e2))
                      await client.disconnect()
                      exit(1)

              await client.disconnect()

          asyncio.run(main())
          PY
