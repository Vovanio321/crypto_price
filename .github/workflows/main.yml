name: Test Update Crypto Prices in Telegram

on:
  workflow_dispatch:  # запуск вручную

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Update Crypto Prices (Test Run)
        run: |
          python3 - <<'EOF'
          import os
          import requests

          # -----------------------------
          # Настройки Telegram
          # -----------------------------
          BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
          CHANNEL = os.environ["TELEGRAM_CHANNEL"]
          MESSAGE_ID = 8  # ID сообщения для редактирования

          # -----------------------------
          # ID криптовалют Coinlore
          # -----------------------------
          COINS = {
              "BTC": "90",
              "ETH": "80",
              "BNB": "2710"
          }

          # -----------------------------
          # ID кастомных эмодзи Telegram
          # -----------------------------
          EMOJI_IDS = {
              "BTC": "CAACAgIAAxUAAWmLVJr29cFH8ePIVMqS1nK07IeNAAJHQgACZYzBSPeaPP6sm0WPOgQ",
              "ETH": "CAACAgIAAxUAAWmLVJpOro8RfUZZFFFR-AidNOTFAAM_AALMg9BIn-EYY0zFKpA6BA",
              "BNB": "CAACAgIAAxUAAWmLVJrC2EmiVGDfGfvOFQABO4QGOQAC3EkAAvYm2UjlPIMpwndmHjoE"
          }

          # -----------------------------
          # Получение цен с Coinlore
          # -----------------------------
          def get_prices():
              url = f"https://api.coinlore.net/api/ticker/?id={','.join(COINS.values())}"
              resp = requests.get(url).json()
              return {coin["symbol"]: float(coin["price_usd"]) for coin in resp}

          # -----------------------------
          # Формируем подпись с кастомными эмодзи
          # -----------------------------
          def format_caption(prices):
              text = f"{prices['BTC']}$ {prices['ETH']}$ {prices['BNB']}$"

              # entities для кастомных эмодзи
              entities = [
                  {"type": "custom_emoji", "offset": 0, "length": 1, "custom_emoji_id": EMOJI_IDS["BTC"]},
                  {"type": "custom_emoji", "offset": len(f"{prices['BTC']}$ "), "length": 1, "custom_emoji_id": EMOJI_IDS["ETH"]},
                  {"type": "custom_emoji", "offset": len(f"{prices['BTC']}$ {prices['ETH']}$ "), "length": 1, "custom_emoji_id": EMOJI_IDS["BNB"]},
              ]
              return text, entities

          # -----------------------------
          # Редактируем сообщение
          # -----------------------------
          def update_message():
              prices = get_prices()
              caption, entities = format_caption(prices)

              payload = {
                  "chat_id": CHANNEL,
                  "message_id": MESSAGE_ID,
                  "text": caption,
                  "entities": entities
              }

              r = requests.post(f"https://api.telegram.org/bot{BOT_TOKEN}/editMessageText", json=payload)
              print(r.text)

          # -----------------------------
          # Запуск один раз
          # -----------------------------
          if __name__ == "__main__":
              update_message()
          EOF
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
