name: Edit Telegram Message with Custom Emojis

on:
  workflow_dispatch:

jobs:
  edit-message:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: python3 -m pip install --upgrade pip telethon requests

      - name: Edit Telegram Message
        env:
          TELETHON_API_ID: ${{ secrets.TELETHON_API_ID }}
          TELETHON_API_HASH: ${{ secrets.TELETHON_API_HASH }}
          TELETHON_SESSION: ${{ secrets.TELETHON_SESSION }}
        run: |
          python3 - <<'PY'
          import os, sys, asyncio, requests
          from requests.adapters import HTTPAdapter
          from requests.packages.urllib3.util.retry import Retry
          from telethon import TelegramClient, types
          from telethon.sessions import StringSession

          # --- config (change CHANNEL/MESSAGE_ID if needed) ---
          CHANNEL = '@test_canal414'
          MESSAGE_ID = 8

          COINS = {"BTC": "90", "ETH": "80", "BNB": "2710"}
          # document/custom_emoji ids (from your message JSON)
          EMOJI_IDS = {
              "BTC": 5213021529092170717,
              "ETH": 5215633431848848497,
              "BNB": 5212948037906766349
          }
          # -----------------------------------------------------

          # check secrets
          if not (os.environ.get('TELETHON_API_ID') and os.environ.get('TELETHON_API_HASH') and os.environ.get('TELETHON_SESSION')):
              print("ERROR: set TELETHON_API_ID, TELETHON_API_HASH and TELETHON_SESSION in repo secrets")
              sys.exit(1)

          API_ID = int(os.environ['TELETHON_API_ID'])
          API_HASH = os.environ['TELETHON_API_HASH']
          SESSION = os.environ['TELETHON_SESSION']

          def utf16_len(s: str) -> int:
              return len(s.encode('utf-16-le')) // 2

          def get_prices():
              session = requests.Session()
              retries = Retry(total=3, backoff_factor=0.5, status_forcelist=[502,503,504])
              session.mount('https://', HTTPAdapter(max_retries=retries))
              url = f"https://api.coinlore.net/api/ticker/?id={','.join(COINS.values())}"
              r = session.get(url, timeout=10)
              r.raise_for_status()
              data = r.json()
              return {item["symbol"]: float(item["price_usd"]) for item in data}

          def make_custom_entity(offset, length, emoji_id):
              # try multiple constructors for compatibility
              try:
                  return types.MessageEntityCustomEmoji(offset=offset, length=length, document_id=emoji_id)
              except TypeError:
                  pass
              try:
                  return types.MessageEntityCustomEmoji(offset=offset, length=length, custom_emoji_id=emoji_id)
              except TypeError:
                  pass
              try:
                  return types.InputMessageEntityCustomEmoji(offset=offset, length=length, document_id=emoji_id)
              except TypeError:
                  pass
              # try raw tl type
              try:
                  from telethon.tl.types import MessageEntityCustomEmoji as RawME
                  return RawME(offset=offset, length=length, document_id=emoji_id)
              except Exception:
                  pass
              raise TypeError("No compatible MessageEntityCustomEmoji constructor found in this Telethon version")

          async def main():
              client = TelegramClient(StringSession(SESSION), API_ID, API_HASH)
              await client.start()

              prices = get_prices()
              text = f"ðŸ“Š {prices['BTC']:.2f}$ ðŸ“Š {prices['ETH']:.2f}$ ðŸ“Š {prices['BNB']:.2f}$"

              # compute UTF-16 offsets
              fallback = "ðŸ“Š"
              offsets = []
              running = ""
              for ch in text:
                  if ch == fallback:
                      offsets.append(utf16_len(running))
                  running += ch

              if len(offsets) != 3:
                  print("Unexpected fallback count:", text, offsets)
                  await client.disconnect()
                  sys.exit(1)

              coins = ["BTC", "ETH", "BNB"]
              length = utf16_len(fallback)

              # build entities robustly
              entities = []
              for i, coin in enumerate(coins):
                  eid = EMOJI_IDS[coin]
                  try:
                      ent = make_custom_entity(offsets[i], length, eid)
                      entities.append(ent)
                  except Exception as e:
                      print("Failed to construct custom emoji entity:", e)
                      entities = None
                      break

              # Try to edit with entities if we have them; otherwise fallback to plain edit
              try:
                  if entities:
                      await client.edit_message(entity=CHANNEL, message=MESSAGE_ID, text=text, entities=entities)
                  else:
                      await client.edit_message(entity=CHANNEL, message=MESSAGE_ID, text=text)
                  print("Edited message successfully.")
              except Exception as e:
                  print("Edit failed:", repr(e))
                  # final fallback: try plain edit once more
                  try:
                      await client.edit_message(entity=CHANNEL, message=MESSAGE_ID, text=text)
                      print("Edited without custom entities (fallback).")
                  except Exception as e2:
                      print("Fallback edit failed:", repr(e2))
                      await client.disconnect()
                      sys.exit(1)

              await client.disconnect()

          asyncio.run(main())
          PY
