name: Edit Telegram Message with Custom Emojis

on:
  workflow_dispatch:

jobs:
  edit-message:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: python3 -m pip install --upgrade pip telethon==1.41.2 requests

      - name: Edit Telegram Message
        env:
          TELETHON_API_ID: ${{ secrets.TELETHON_API_ID }}
          TELETHON_API_HASH: ${{ secrets.TELETHON_API_HASH }}
          TELETHON_SESSION: ${{ secrets.TELETHON_SESSION }}
        run: |
          python3 - <<'PY'
          import os, asyncio, sys, requests
          from telethon import TelegramClient, types
          from telethon.sessions import StringSession

          API_ID = int(os.environ['TELETHON_API_ID'])
          API_HASH = os.environ['TELETHON_API_HASH']
          SESSION = os.environ['TELETHON_SESSION']

          CHANNEL = '@test_canal414'
          MESSAGE_ID = 8

          COINS = {"BTC": "90", "ETH": "80", "BNB": "2710"}
          EMOJI_IDS = {"BTC": 5213021529092170717, "ETH": 5215633431848848497, "BNB": 5212948037906766349}

          def utf16_len(s): return len(s.encode("utf-16-le")) // 2

          def get_prices():
              url = f"https://api.coinlore.net/api/ticker/?id={','.join(COINS.values())}"
              r = requests.get(url, timeout=10)
              r.raise_for_status()
              data = r.json()
              return {item["symbol"]: float(item["price_usd"]) for item in data}

          async def main():
              client = TelegramClient(StringSession(SESSION), API_ID, API_HASH)
              await client.start()

              prices = get_prices()
              text = f"ðŸ“Š {prices['BTC']:.2f}$ ðŸ“Š {prices['ETH']:.2f}$ ðŸ“Š {prices['BNB']:.2f}$"

              fallback = "ðŸ“Š"
              offsets = [utf16_len(text[:i]) for i, ch in enumerate(text) if ch == fallback]
              coins = ["BTC", "ETH", "BNB"]
              length = utf16_len(fallback)

              # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ InputMessageEntityCustomEmoji Ð²Ð¼ÐµÑÑ‚Ð¾ ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ MessageEntityCustomEmoji
              entities = [
                  types.InputMessageEntityCustomEmoji(offset=offsets[i], length=length, document_id=EMOJI_IDS[coins[i]])
                  for i in range(len(coins))
              ]

              await client.edit_message(entity=CHANNEL, message=MESSAGE_ID, text=text, entities=entities)
              print("Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¼Ð¸ ÑÐ¼Ð¾Ð´Ð·Ð¸!")

              await client.disconnect()

          asyncio.run(main())
          PY
