name: Update Crypto Prices in Telegram (keep custom emojis)

on:
  workflow_dispatch:  # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∞

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Update Prices Only (keep emojis)
        run: |
          python3 - <<'EOF'
          import os
          import requests
          import re

          BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
          CHANNEL = os.environ["TELEGRAM_CHANNEL"]
          MESSAGE_ID = 8  # ID —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º

          # ID –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç Coinlore
          COINS = {"BTC": "90", "ETH": "80", "BNB": "2710"}

          def get_prices():
              url = f"https://api.coinlore.net/api/ticker/?id={','.join(COINS.values())}"
              resp = requests.get(url).json()
              return {coin["symbol"]: float(coin["price_usd"]) for coin in resp}

          def edit_message():
              prices = get_prices()

              # –¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —ç–º–æ–¥–∑–∏
              # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —á–µ—Ä–µ–∑ getUpdates –∏–ª–∏ getChatHistory
              current_text = "ü§ë 69423.65$ ü§ë 2025.44$ ü§ë 620.45$"

              # –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ –ø—Ä–æ–±–µ–ª–∞–º, –∑–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
              parts = current_text.split(' ')
              new_parts = []
              price_values = [prices['BTC'], prices['ETH'], prices['BNB']]
              price_index = 0

              for part in parts:
                  if re.match(r'^\d+(\.\d+)?\$$', part):
                      # –∑–∞–º–µ–Ω—è–µ–º —á–∏—Å–ª–æ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
                      new_parts.append(f"{price_values[price_index]:.2f}$")
                      price_index += 1
                  else:
                      # –æ—Å—Ç–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º
                      new_parts.append(part)

              new_text = ' '.join(new_parts)

              payload = {
                  "chat_id": CHANNEL,
                  "message_id": MESSAGE_ID,
                  "text": new_text
              }
              r = requests.post(f"https://api.telegram.org/bot{BOT_TOKEN}/editMessageText", json=payload)
              print(r.text)

          if __name__ == "__main__":
              edit_message()
          EOF
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
