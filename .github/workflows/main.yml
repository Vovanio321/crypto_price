name: Send and Update Crypto Prices in Telegram

on:
  workflow_dispatch:  # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∞

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Send or Update Crypto Prices
        run: |
          python3 - <<'EOF'
          import os
          import requests
          import json
          import re

          BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
          CHANNEL = os.environ["TELEGRAM_CHANNEL"]
          MESSAGE_ID_FILE = "message_id.txt"

          COINS = {"BTC": "90", "ETH": "80", "BNB": "2710"}

          def get_prices():
              url = f"https://api.coinlore.net/api/ticker/?id={','.join(COINS.values())}"
              resp = requests.get(url).json()
              return {coin["symbol"]: float(coin["price_usd"]) for coin in resp}

          def send_initial_message(prices):
              # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —ç–º–æ–¥–∑–∏ –∏ —Ü–µ–Ω–∞–º–∏
              text = f"ü§ë {prices['BTC']:.2f}$ ü§ë {prices['ETH']:.2f}$ ü§ë {prices['BNB']:.2f}$"
              payload = {
                  "chat_id": CHANNEL,
                  "text": text
              }
              r = requests.post(f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage", json=payload)
              result = r.json()
              print(result)
              # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id
              with open(MESSAGE_ID_FILE, "w") as f:
                  f.write(str(result["result"]["message_id"]))

          def edit_message(prices, message_id):
              # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API
              # –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç, –æ—Å—Ç–∞–≤–ª—è—è –∫–∞—Å—Ç–æ–º–Ω—ã–µ —ç–º–æ–¥–∑–∏
              text = f"ü§ë {prices['BTC']:.2f}$ ü§ë {prices['ETH']:.2f}$ ü§ë {prices['BNB']:.2f}$"
              payload = {
                  "chat_id": CHANNEL,
                  "message_id": message_id,
                  "text": text
              }
              r = requests.post(f"https://api.telegram.org/bot{BOT_TOKEN}/editMessageText", json=payload)
              print(r.text)

          if __name__ == "__main__":
              prices = get_prices()
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π message_id
              if os.path.exists(MESSAGE_ID_FILE):
                  with open(MESSAGE_ID_FILE, "r") as f:
                      message_id = int(f.read().strip())
                  edit_message(prices, message_id)
              else:
                  send_initial_message(prices)
          EOF
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
