name: Edit Telegram Message with Custom Emojis

on:
  workflow_dispatch:  # —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  edit-message:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: python3 -m pip install --upgrade pip telethon==1.31.1 requests

      - name: Edit Telegram Message
        env:
          TELETHON_API_ID: ${{ secrets.TELETHON_API_ID }}
          TELETHON_API_HASH: ${{ secrets.TELETHON_API_HASH }}
          TELETHON_SESSION: ${{ secrets.TELETHON_SESSION }}
        run: |
          python3 - <<'PY'
          import os, asyncio, sys
          import requests
          from telethon import TelegramClient, types
          from telethon.sessions import StringSession

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
          if not os.environ.get("TELETHON_API_ID") or not os.environ.get("TELETHON_API_HASH") or not os.environ.get("TELETHON_SESSION"):
              print("–û—à–∏–±–∫–∞: –Ω–µ –∑–∞–¥–∞–Ω—ã TELETHON_API_ID, TELETHON_API_HASH –∏–ª–∏ TELETHON_SESSION")
              sys.exit(1)

          API_ID = int(os.environ['TELETHON_API_ID'])
          API_HASH = os.environ['TELETHON_API_HASH']
          SESSION = os.environ['TELETHON_SESSION']

          # –ö–∞–Ω–∞–ª –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
          CHANNEL = '@test_canal414'  # —Ç–≤–æ–π –∫–∞–Ω–∞–ª
          MESSAGE_ID = 8              # ID —Å–æ–æ–±—â–µ–Ω–∏—è

          # –ú–æ–Ω–µ—Ç—ã –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —ç–º–æ–¥–∑–∏
          COINS = {"BTC": "90", "ETH": "80", "BNB": "2710"}
          EMOJI_IDS = {
              "BTC": 5213021529092170717,
              "ETH": 5215633431848848497,
              "BNB": 5212948037906766349
          }

          # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã
          def get_prices():
              url = f"https://api.coinlore.net/api/ticker/?id={','.join(COINS.values())}"
              r = requests.get(url, timeout=10)
              r.raise_for_status()
              data = r.json()
              return {item["symbol"]: float(item["price_usd"]) for item in data}

          async def main():
              client = TelegramClient(StringSession(SESSION), API_ID, API_HASH)
              await client.start()

              prices = get_prices()
              text = f"üìä {prices['BTC']:.2f}$ üìä {prices['ETH']:.2f}$ üìä {prices['BNB']:.2f}$"

              fallback = "üìä"
              offsets = [i for i, ch in enumerate(text) if ch == fallback]
              coins = ["BTC", "ETH", "BNB"]

              entities = [
                  types.MessageEntityCustomEmoji(
                      offset=offsets[i],
                      length=len(fallback),
                      custom_emoji_id=EMOJI_IDS[coin]
                  )
                  for i, coin in enumerate(coins)
              ]

              await client.edit_message(
                  entity=CHANNEL,
                  message=MESSAGE_ID,
                  text=text,
                  entities=entities
              )
              print("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ!")

              await client.disconnect()

          asyncio.run(main())
          PY
